#include <sched.h>
#include <console.h>
#include <xen/xen.h>

#include <mini-os/mm.h>
#include <mini-os/gdt.h>

#include "sum.h" // generated by cgo

extern void _rt0_amd64_netbsd_lib(void);

void thread_main(void *ctx) {
    start_info_t *si;
    unsigned long tls_page;
    unsigned int v;
    GoInt i;

    si = (start_info_t *)ctx;
    printk("go_main.c: thread_main(%p)\n", si);

    tls_page = alloc_page();
    printk("Virtual address of TLS page: 0x%lx\n", tls_page);
    switch_fs(tls_page + PAGE_SIZE);

    /* TEST TLS */
    *(int *)(tls_page + PAGE_SIZE - 8) = 9876;
    __asm__ __volatile__("mov %%fs:0xfffffffffffffff8, %0" : "=r"(v));
    if(v != 9876) {
        printk("Could not successfully set up TLS\n");
        *(char *)0 = 0;
    }


    _rt0_amd64_netbsd_lib();
    i = Sum(3, 4);
    printk("go_main.c: result: %lld\n", i);
}

int app_main(start_info_t *si) {
    printk("go_main.c: app_main(%p)\n", si);
    create_thread("main", thread_main, si);
    return 0;
}
